<!doctype html>
<ul id="leaderboard"></ul>
<script src="/socket.io/socket.io.js"></script>
<script>
  (function () {
    var list = document.getElementById("leaderboard")
    var socket = io("http://localhost:8080")

    socket.on("state", function (data) {
      var state = data["Nodebot Workshop"]
      if (!state) return;

      console.log("Got new state", state)

      var students = Object.keys(state).map(function (ip) {
        return {
          ip: ip,
          name: state[ip].name,
          count: state[ip].exercises.length,
          last: state[ip].exercises[state[ip].exercises.length - 1]
        }
      }).sort(function (a, b) {
        if (a.count < b.count) {
          return -1
        } else if (a.count > b.count) {
          return 1
        } else if (a.last.timestamp < b.last.timestamp) {
          return 1
        } else if (a.last.timestamp > b.last.timestamp) {
          return -1
        }
        return 0
      })
      
      console.log(students)

      list.innerHTML = ""

      students.forEach(function (s) {
        list.appendChild(createItem(s))
      })
    })
    
    function createItem (s) {
      var item = document.createElement("li")

      var ip = document.createElement("span")
      ip.className = "name"
      ip.appendChild(document.createTextNode(s.name || s.ip))

      item.appendChild(ip)

      var count = document.createElement("span")
      count.className = "count"
      count.appendChild(document.createTextNode(s.count))

      item.appendChild(count)

      var last = document.createElement("span")
      last.className = "last"
      last.appendChild(document.createTextNode(s.last.name))

      item.appendChild(last)

      var time = document.createElement("time")
      time.setAttribute("datetime", new Date(s.last.timestamp).toISOString())
      time.appendChild(document.createTextNode(new Date(s.last.timestamp).toString()))

      item.appendChild(time)
      
      return item
    }
  })()
</script>